---
# tasks file for sbaerlocher.virtio

- name: add OS specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}-{{ ansible_distribution_version }}.yml"
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
        - "defaults.yml"
      paths:
        -  "vars"
  tags:
    - configuration
    - packages

- name: Get list of all drivers
  win_command: driverquery /V
  changed_when: False
  register: driver_list
  tags:
    - configuration
    - packages

- name: Check if Red Hat certificate is not already installed
  win_shell: 'Get-ChildItem -Path Cert:\LocalMachine\TrustedPublisher'
  changed_when: False
  register: cert_check
  tags:
    - configuration
    - packages

- name: Download virtio-win.iso
  win_get_url:
    url: "{{ virtio_win_iso_url }}"
    force: no
    dest: "{{ ansible_env.TEMP }}\\virtio-win.iso"
  tags:
    - configuration
    - packages

- name: Mount virtio-win.iso
  win_disk_image:
    image_path: "{{ ansible_env.TEMP }}\\virtio-win.iso"
  register: win_disk_image
  tags:
    - configuration
    - packages

- block:
  - name: Export Cert powershell
    win_shell: '$cert = (Get-AuthenticodeSignature "{{ win_disk_image.mount_path }}\Balloon\{{ virtio_driver_directory }}\amd64\blnsvr.exe").SignerCertificate; [System.IO.File]::WriteAllBytes("{{ ansible_env.TEMP }}\redhat.cer", $cert.Export([System.Security.Cryptography.X509Certificates.X509ContentType]::Cert));'

  - name: Install RH certificate to TrustedPublisher certificate store
    win_command: 'certutil.exe -f -addstore "TrustedPublisher" {{ ansible_env.TEMP }}\redhat.cer'
  when: not cert_check.stdout | search("Red Hat")
  tags:
    - configuration
    - packages

- name: Install the Virtio Network Driver (netkvm)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\NetKVM\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("netkvm")
  tags:
    - configuration
    - packages

- name: Install the Virtio Block Driver (viostor)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\viostor\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("viostor")
  tags:
    - configuration
    - packages

- name: Install the QXL Graphics Driver (qxldod)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\qxldod\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("qxldod")
  tags:
    - configuration
    - packages

- name: Install the Balloon Driver (Balloon)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\Balloon\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("balloon")
  tags:
    - configuration
    - packages

- name: Install Virtio RNG driver (viorng)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\viorng\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("viorng")
  tags:
    - configuration
    - packages

- name: Install Virtio serial driver (vioserial)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\vioserial\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("vioser")
  tags:
    - configuration
    - packages

- name: Install Virtio Input driver (vioinput)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\vioinput\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("vioinput")
  tags:
    - configuration
    - packages

- name: Install pvpanic device driver (pvpanic)
  win_command: "pnputil -i -a \"{{ win_disk_image.mount_path }}\\pvpanic\\{{ virtio_driver_directory }}\\{{ ansible_env.PROCESSOR_ARCHITECTURE | lower }}\\*.inf\""
  when: not driver_list.stdout | search("pvpanic")
  tags:
    - configuration
    - packages

- name: Install Qemu Guest Agent (qemu-ga-x64.msi)
  win_package:
    path: "{{ win_disk_image.mount_path }}\\guest-agent\\qemu-ga-x64.msi"
    creates_path: "{{ ansible_env['ProgramFiles'] }}\\qemu-ga"
  tags:
    - configuration
    - packages

- name: Unmount virtio-win.iso
  win_disk_image:
    image_path: "{{ ansible_env.TEMP }}\\virtio-win.iso"
    state: absent
  tags:
    - configuration
    - packages

- name: Delete previously downloaded iso and the certificates {{ ansible_env.SystemDrive }}\redhat.cer
  win_file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ ansible_env.TEMP }}\\redhat.cer"
    - "{{ ansible_env.TEMP }}\\virtio-win.iso"
  tags:
    - configuration
    - packages